<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Swagger2Apis Helper</title>
    <link href="./bootstrap.min.css" rel="stylesheet" />
    <style>
      .container {
        max-width: 800px;
        margin-top: 50px;
      }
      #status {
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Swagger2Apis å¿«é€Ÿæ¥å…¥åŠ©æ‰‹</h1>

      <div class="alert alert-info" role="alert">
        <h4 class="alert-heading"></h4>
        <p>æœ¬å·¥å…·å¯ä»¥å¸®åŠ©æ‚¨ğŸš€ å¿«é€Ÿæ¥å…¥ swagger2apis</p>
        <p>åªéœ€ä¸‰æ­¥å³å¯å®Œæˆæ¥å…¥:</p>
        <ol>
          <li>é€‰æ‹©é¡¹ç›®æ ¹ç›®å½•</li>
          <li>å¡«å†™é…ç½®ä¿¡æ¯</li>
          <li>ç‚¹å‡»ç”ŸæˆæŒ‰é’®</li>
        </ol>
      </div>

      <div class="alert alert-warning" role="alert">
        <h4 class="alert-heading">âš ï¸ ä½¿ç”¨å‰è¯·æ³¨æ„ï¼š</h4>
        <ol>
          <li>è¯·ç¡®ä¿ Git å·¥ä½œåŒºå¤„äºå¹²å‡€çŠ¶æ€ï¼Œä»¥ä¾¿åœ¨éœ€è¦æ—¶å¯ä»¥è½»æ¾å›é€€æ›´æ”¹ã€‚</li>
          <li>ç”Ÿæˆçš„é…ç½®æ–‡ä»¶å¯èƒ½éœ€è¦æ ¹æ®æ‚¨çš„é¡¹ç›®éœ€æ±‚è¿›è¡Œè°ƒæ•´ï¼Œè¯·æ£€æŸ¥å¹¶åˆ é™¤ä¸éœ€è¦çš„å†…å®¹ã€‚</li>
          <li>
            è¯·ç¡®ä¿é¡¹ç›®å·²å®‰è£…ä»¥ä¸‹ä¾èµ–ï¼š
            <ul>
              <li><code>swagger2apis</code></li>
              <li><code>axios</code></li>
              <li><code>prettier</code></li>
            </ul>
            æ‚¨å¯ä»¥é€‰æ‹©å°†å®ƒä»¬å®‰è£…ä¸º <code>dependencies</code> æˆ– <code>devDependencies</code>ã€‚
          </li>
          <li>
            æ³¨æ„ï¼Œè¿™é‡Œå¹¶ä¸èƒ½å¸®ä½ å®Œæˆæ‰€æœ‰çš„ä¸€åˆ‡ï¼Œå½“è¿™é‡Œä¸€åˆ‡å®Œæ¯•åï¼Œä½ è¿˜æ˜¯éœ€è¦æœ€åä¸€æ­¥:ä¹¦å†™è‡ªå·±çš„é€‚é…å™¨ï¼Œå…³äºé€‚é…å™¨ï¼š<a
              href="https://www.npmjs.com/package/swagger2apis#%E5%85%B3%E4%BA%8E%E9%80%82%E9%85%8D%E5%99%A8"
              target="_blank"
              >æŸ¥çœ‹æ–‡æ¡£</a
            >
          </li>
        </ol>
      </div>

      <div class="mb-3">
        <label class="form-label">é€‰æ‹©é¡¹ç›®æ ¹ç›®å½•ï¼š</label>
        <div class="input-group">
          <input type="text" class="form-control" id="projectPath" readonly />
          <button class="btn btn-primary" id="selectFolder">é€‰æ‹©ç›®å½•</button>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">é…ç½®æ–‡ä»¶è·¯å¾„ï¼š</label>
        <input type="text" class="form-control" id="configPath" placeholder="è¯·è¾“å…¥é…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆé»˜è®¤ä¸º api/s2a.mjsï¼‰" />
      </div>

      <div class="mb-3">
        <label class="form-label">Swagger API JSONåœ°å€ï¼š </label>
        <input type="text" class="form-control" id="swaggerUrl" placeholder="ä¸å¡«å†™ä¼šä½¿ç”¨ç¤ºä¾‹JSON" />
      </div>

      <button class="btn btn-success" id="generate">ç”Ÿæˆé…ç½®</button>

      <div id="status" class="alert" style="display: none"></div>
    </div>

    <script>
      let directoryHandle;

      document.getElementById("selectFolder").addEventListener("click", async () => {
        try {
          // ä½¿ç”¨ showDirectoryPicker é€‰æ‹©ç›®å½•
          directoryHandle = await window.showDirectoryPicker();
          document.getElementById("projectPath").value = directoryHandle.name;
        } catch (error) {
          showStatus("é€‰æ‹©ç›®å½•å¤±è´¥ï¼š" + error.message, "danger");
        }
      });

      document.getElementById("generate").addEventListener("click", async () => {
        const projectPath = document.getElementById("projectPath").value;
        const swaggerUrl = document.getElementById("swaggerUrl").value;
        const configPath = document.getElementById("configPath").value || "api/s2a.mjs";

        if (!directoryHandle) {
          showStatus("è¯·é€‰æ‹©é¡¹ç›®ç›®å½•", "danger");
          return;
        }

        try {
          // è¯»å–å¹¶æ›´æ–° package.json
          const packageJsonHandle = await getFileHandle(directoryHandle, "package.json");
          const packageJsonFile = await packageJsonHandle.getFile();
          const packageJson = JSON.parse(await packageJsonFile.text());

          // æ›´æ–° generate-api è„šæœ¬ä»¥ä½¿ç”¨è‡ªå®šä¹‰è·¯å¾„
          packageJson.scripts = {
            ...packageJson.scripts,
            "generate-api": `node ./${configPath}`
          };

          // å†™å…¥æ›´æ–°åçš„ package.json
          await writeFile(packageJsonHandle, JSON.stringify(packageJson, null, 2));

          // åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„
          const pathParts = configPath.split("/");
          const fileName = pathParts.pop();
          let currentHandle = directoryHandle;

          // é€’å½’åˆ›å»ºç›®å½•
          for (const part of pathParts) {
            currentHandle = await currentHandle.getDirectoryHandle(part, { create: true });
          }

          // åˆ›å»ºé…ç½®æ–‡ä»¶
          const s2aHandle = await currentHandle.getFileHandle(fileName, { create: true });
          await writeFile(
            s2aHandle,
            `import path from "node:path";
      import {
        __dirname_esm,
        create,
        GroupRender,
        ENTRY_FILE_NAME,
        createCodeFormatterPlugin,
        createResponseWrapperPlugin,
        CleanDirPlugin,
        createCompileTS2JSPlugin
      } from "swagger2apis";
      import axios from "axios";

function getGithubFileContent(owner, repo, path, branch = "main") {
  /**
   * è·å– GitHub ä»“åº“ä¸­æŒ‡å®šæ–‡ä»¶çš„å†…å®¹
   *
   * @param {string} owner - ä»“åº“æ‰€æœ‰è€…
   * @param {string} repo - ä»“åº“åç§°
   * @param {string} path - æ–‡ä»¶è·¯å¾„
   * @param {string} branch - åˆ†æ”¯åç§°(é»˜è®¤ä¸ºmain)
   * @returns {Promise<string|null>} æ–‡ä»¶å†…å®¹æˆ–null
   */

  const url = \`https://api.github.com/repos/\${owner}/\${repo}/contents/\${path}?ref=\${branch}\`;

  return new Promise((resolve) => {
    axios.get(url, {
      headers: {
        Accept: "application/vnd.github.v3.raw",
      },
    })
    .then(response => {
      resolve(response.data);
    })
    .catch(error => {
      console.error("è·å–æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯:", error.message);
      resolve(null);
    });
  });
}

      // è·å– Swagger JSON
      let swaggerJSON;
        if ("${swaggerUrl}") {
          const response = await axios.get(\`${swaggerUrl}\`).data;
          swaggerJSON = response;
        } else {
          // ä½¿ç”¨ç¤ºä¾‹ JSON
          const owner = "pandavips";
          const repo = "swagger2apis";
          const filePath = "/packages/example/json/swagger_2.json";
          const branch = "main";
          swaggerJSON = await getGithubFileContent(owner, repo, filePath, branch);
      }

      const app = create(
        // æ³¨æ„è¿™é‡Œæ˜¯ä¸€ä¸ªå¯¹è±¡,ä¸æ˜¯å­—ç¬¦ä¸²
        swaggerJSON,
        {
          outdir: path.join(
            __dirname_esm(import.meta.url),
            // è¿™é‡Œå®é™…ä¸Šå¯ä»¥ç†è§£ä¸ºå‘½ä»¤ç©ºé—´
            "./ALLIN"
          ),
          // æ•æ„Ÿä¿¡æ¯å¼€å…³
          safe: false
        }
      );

      // ä½¿ç”¨ä»£ç æ ¼å¼åŒ–æ’ä»¶,ä½ å¯ä»¥ä¼ å…¥é¡¹ç›®ä¸­çš„ä»£ç æ ¼å¼åŒ–é…ç½®æ¥ä¿æŒä»£ç é£æ ¼ç»Ÿä¸€
      app.usePlugin(createCodeFormatterPlugin({}));

      // æœ‰äº›åç«¯å–œæ¬¢åœ¨å¤–å±‚åŒ…ä¸€å±‚çŠ¶æ€å±‚,è¿™ä¸ªæ’ä»¶å¯ä»¥å°†å“åº”æ ‡æ³¨ä¹ŸåŒ…è£¹ä¸€å±‚çŠ¶æ€å±‚,ä½ å¾ˆå¯èƒ½éœ€è¦æ ¹æ®ä½ å¸åç«¯çš„æ•°æ®ç»“æ„æ¥è¿›è¡Œè°ƒæ•´
      const ApiResponseWrapperName = "ApiResponseWrapper";
      const ApiResponseWrapperType = \`
      declare interface \${ApiResponseWrapperName}<T>{
        data: T;
        success: boolean;
        code: string;
        msg: string;
      }
      \`;
      app.usePlugin(createResponseWrapperPlugin(ApiResponseWrapperName, ApiResponseWrapperType));

      // æ¸…ç†å·¥ä½œç›®å½•
      app.usePlugin(CleanDirPlugin);

      /**
       * ç¼–è¯‘tsæ–‡ä»¶,(å¯é€‰)ä½ å¯ä»¥ä¼ å…¥tsconfigå’ŒprettierConfigæ¥çµæ´»çš„è°ƒæ•´ç¼–è¯‘é…ç½®,
       * è¿™ä¸ªæ’ä»¶ç¼–è¯‘å,tsæ–‡ä»¶ä¸ä¼šåˆ é™¤,å› ä¸ºä¸ªäººè§‰å¾—tsæ–‡ä»¶å¯ä»¥ç”¨æ¥å½“åšæ–‡æ¡£æŸ¥çœ‹,æ‰€ä»¥æ²¡æœ‰è¿›è¡Œåˆ é™¤
       * å¦‚æœä½ æœ‰åˆ é™¤tsæ–‡ä»¶çš„éœ€æ±‚,å¯ä»¥è‡ªè¡Œå†™ä¸ªæ’ä»¶æ¥åˆ é™¤è¿™äº›tsæ–‡ä»¶
       */
      app.usePlugin(
        createCompileTS2JSPlugin(
          {
            baseUrl: "./",
            paths: {
              "@/*": ["./src/*"]
            }
          },
          {
            parser: "typescript",
            printWidth: 200,
            semi: true,
            singleQuote: false
          }
        )
      );

      // å¦‚æœä½ ä¸å¸Œæœ›å°†æ‰€æœ‰å®šä¹‰éƒ½æ”¾åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­,å¯ä»¥ä½¿ç”¨GroupRenderæ¥è¿›è¡Œåˆ†ç»„æ¸²æŸ“
      const isGroupRender = true;
      isGroupRender && app.cutstomRender(GroupRender);

      // startä¸ä»…ä»…å¯ä»¥ä¼ å…¥å­—ç¬¦ä¸²,ä¹Ÿå¯ä»¥ä¼ å…¥ä¸€ä¸ªå‡½æ•°,é€šè¿‡è¿™ä¸ªå‡½æ•°æ¥çµæ´»çš„å®ç°é€‚é…å™¨çš„å¯¼å…¥
      app.start((node) => {
        if (isGroupRender && node.fileName === ENTRY_FILE_NAME) {
          // æ¯”å¦‚è¿™é‡Œç”±äºæˆ‘ä»¬ä½¿ç”¨äº†GroupRender,ä¸»æ–‡ä»¶å°±ä¸å†éœ€è¦å¯¼å…¥é€‚é…å™¨äº†
          return "";
        } else {
          return "import { adaptorFn } from './request.ts';";
        }
      });
      `
          );

          showStatus(`é…ç½®ç”ŸæˆæˆåŠŸï¼è¯·è¿›å…¥ ${projectPath} ç›®å½•æ‰§è¡Œ npm run generate-api`, "success");
        } catch (error) {
          showStatus(`é”™è¯¯ï¼š${error.message}`, "danger");
        }
      });

      // è¾…åŠ©å‡½æ•°ï¼šè·å–æ–‡ä»¶å¥æŸ„
      async function getFileHandle(dirHandle, fileName) {
        try {
          return await dirHandle.getFileHandle(fileName);
        } catch (error) {
          throw new Error(`æ— æ³•æ‰¾åˆ° ${fileName}ï¼š${error.message}`);
        }
      }

      // è¾…åŠ©å‡½æ•°ï¼šå†™å…¥æ–‡ä»¶
      async function writeFile(fileHandle, contents) {
        const writable = await fileHandle.createWritable();
        await writable.write(contents);
        await writable.close();
      }

      function showStatus(message, type) {
        const status = document.getElementById("status");
        status.textContent = message;
        status.className = `alert alert-${type}`;
        status.style.display = "block";
      }
    </script>
  </body>
</html>
